"""
SIREN Report Exporter
======================
Exports IncidentReport objects to Markdown and JSON formats.
Markdown output follows professional incident report formatting
suitable for stakeholder communication and archival.
"""

import json
from src.report_engine import IncidentReport


class ReportExporter:
    """Handles exporting an IncidentReport to various formats."""

    def __init__(self, report: IncidentReport):
        self.report = report

    # ------------------------------------------------------------------
    # Markdown export
    # ------------------------------------------------------------------

    def to_markdown(self) -> str:
        """
        Generate a professional Markdown incident report.

        Sections follow the NIST 800-61 incident handling lifecycle:
        Preparation â†’ Detection â†’ Containment â†’ Eradication â†’ Recovery â†’ Lessons Learned
        """
        r = self.report
        score_data = r.calculate_severity_score()
        severity_badge = self._severity_badge(r.severity)

        lines = []
        lines.append(f"# ğŸš¨ Incident Report: {r.title}")
        lines.append("")
        lines.append(f"**Incident ID:** `{r.incident_id}`  ")
        lines.append(f"**Generated:** {r.created_at}  ")
        lines.append(f"**Generated by:** SIREN v1.0.0")
        lines.append("")
        lines.append("---")
        lines.append("")

        # â”€â”€ Metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        lines.append("## ğŸ“‹ Incident Metadata")
        lines.append("")
        lines.append(f"| Field | Value |")
        lines.append(f"|-------|-------|")
        lines.append(f"| **Severity** | {severity_badge} {r.severity} |")
        lines.append(f"| **Category** | {r.category} |")
        lines.append(f"| **Analyst** | {r.analyst} |")
        lines.append(f"| **Severity Score** | {score_data['score']}/10 ({score_data['rating']}) |")
        lines.append(f"| **Detection Date** | {r.detection_date or 'N/A'} |")
        lines.append(f"| **Containment Date** | {r.containment_date or 'N/A'} |")
        lines.append(f"| **Eradication Date** | {r.eradication_date or 'N/A'} |")
        lines.append(f"| **Recovery Date** | {r.recovery_date or 'N/A'} |")
        lines.append("")

        if r.description:
            lines.append(f"**Description:** {r.description}")
            lines.append("")

        # â”€â”€ Executive Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if r.executive_summary:
            lines.append("---")
            lines.append("")
            lines.append("## ğŸ“ Executive Summary")
            lines.append("")
            lines.append(r.executive_summary)
            lines.append("")

        # â”€â”€ Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if r.timeline_events:
            lines.append("---")
            lines.append("")
            lines.append("## ğŸ• Incident Timeline")
            lines.append("")
            lines.append("| # | Timestamp | Event | Source |")
            lines.append("|---|-----------|-------|--------|")
            for idx, event in enumerate(r.timeline_events, 1):
                source = event.source if event.source else "â€”"
                lines.append(
                    f"| {idx} | `{event.timestamp}` | {event.description} | {source} |"
                )
            lines.append("")

        # â”€â”€ IOCs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if r.iocs:
            lines.append("---")
            lines.append("")
            lines.append("## ğŸ” Indicators of Compromise (IOCs)")
            lines.append("")
            lines.append("| # | Type | Value | Context |")
            lines.append("|---|------|-------|---------|")
            for idx, ioc in enumerate(r.iocs, 1):
                context = ioc.context if ioc.context else "â€”"
                lines.append(
                    f"| {idx} | {ioc.ioc_type} | `{ioc.value}` | {context} |"
                )
            lines.append("")

        # â”€â”€ Affected Systems â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if r.affected_systems:
            lines.append("---")
            lines.append("")
            lines.append("## ğŸ’» Affected Systems")
            lines.append("")
            lines.append("| # | Hostname | IP Address | Impact |")
            lines.append("|---|----------|------------|--------|")
            for idx, sys in enumerate(r.affected_systems, 1):
                impact = sys.impact if sys.impact else "â€”"
                lines.append(
                    f"| {idx} | `{sys.hostname}` | `{sys.ip_address}` | {impact} |"
                )
            lines.append("")

        # â”€â”€ Severity Score Breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        lines.append("---")
        lines.append("")
        lines.append("## ğŸ“Š Severity Score Breakdown")
        lines.append("")
        lines.append(f"| Factor | Score |")
        lines.append(f"|--------|-------|")
        lines.append(f"| Base Severity | {score_data['breakdown']['base_severity']} |")
        lines.append(f"| IOC Factor (+0.5/IOC, max 3) | {score_data['breakdown']['ioc_factor']} |")
        lines.append(f"| System Factor (+0.75/system, max 3) | {score_data['breakdown']['system_factor']} |")
        lines.append(f"| Critical Bonus | {score_data['breakdown']['critical_bonus']} |")
        lines.append(f"| **Total** | **{score_data['score']}/10 ({score_data['rating']})** |")
        lines.append("")

        # â”€â”€ Recommendations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if r.recommendations:
            lines.append("---")
            lines.append("")
            lines.append("## âœ… Recommendations")
            lines.append("")
            for idx, rec in enumerate(r.recommendations, 1):
                lines.append(f"{idx}. {rec}")
            lines.append("")

        # â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        lines.append("---")
        lines.append("")
        lines.append(
            "*Report generated by [SIREN](https://github.com/Rootless-Ghost/SIREN) "
            "â€” Security Incident Response Engine & Notation*"
        )

        return "\n".join(lines)

    # ------------------------------------------------------------------
    # JSON export
    # ------------------------------------------------------------------

    def to_json(self) -> str:
        """Serialize the report to a formatted JSON string."""
        return json.dumps(self.report.to_dict(), indent=2, ensure_ascii=False)

    # ------------------------------------------------------------------
    # Helpers
    # ------------------------------------------------------------------

    @staticmethod
    def _severity_badge(severity: str) -> str:
        """Return an emoji badge for the severity level."""
        badges = {
            "Low": "ğŸŸ¢",
            "Medium": "ğŸŸ¡",
            "High": "ğŸŸ ",
            "Critical": "ğŸ”´",
        }
        return badges.get(severity, "âšª")
